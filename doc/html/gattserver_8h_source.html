<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Gyro and Peripheral NRF52-DK Demo: src/gattserver.h Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Gyro and Peripheral NRF52-DK Demo
   &#160;<span id="projectnumber">1.0.3</span>
   </div>
   <div id="projectbrief">The device will start and make advertising every 5 seconds and user could find the device by NRF connect. As user connect he/she should see a custom service with a few characteristics: gyro AX, AY, AZ and peripheral control. Select the peripheral control and send the command (0x01, 0x02, 0x03) to turn led on. After this, user could read the last gyro values (just update these values, when we have moves - interrupts from the sensor) from the gyro characteristick.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="dir_68267d1309a1af8e8297ef4c3efbcdba.html">src</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">gattserver.h</div>  </div>
</div><!--header-->
<div class="contents">
<a href="gattserver_8h.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="preprocessor">#pragma once</span></div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160; </div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="preprocessor">#ifndef __GATT_SERVER_H__</span></div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="preprocessor">#define __GATT_SERVER_H__</span></div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160; </div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="preprocessor">#include &lt;stdint.h&gt;</span></div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;<span class="preprocessor">#include &lt;math.h&gt;</span></div>
<div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160; </div>
<div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;<span class="preprocessor">#include &lt;events/mbed_events.h&gt;</span></div>
<div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;<span class="preprocessor">#include &lt;platform/Callback.h&gt;</span></div>
<div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;<span class="preprocessor">#include &lt;platform/NonCopyable.h&gt;</span></div>
<div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160; </div>
<div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;<span class="preprocessor">#include &lt;Gap.h&gt;</span></div>
<div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;<span class="preprocessor">#include &lt;gap/AdvertisingDataParser.h&gt;</span></div>
<div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;<span class="preprocessor">#include &lt;ble/common/FunctionPointerWithContext.h&gt;</span></div>
<div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160; </div>
<div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;<span class="comment">/* Device name in nRF Connect */</span></div>
<div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;<span class="preprocessor">#define DEV_NAME &quot;Gyro &amp; Peripheral Server&quot;</span></div>
<div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160; </div>
<div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;<span class="comment">/* Payload size */</span></div>
<div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;<span class="preprocessor">#define MAX_ADVERTISING_PAYLOAD_SIZE 50</span></div>
<div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160; </div>
<div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="syslogger_8h.html">syslogger.h</a>&quot;</span></div>
<div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160; </div>
<div class="line"><a name="l00038"></a><span class="lineno"><a class="line" href="classBLEProcess.html">   38</a></span>&#160;<span class="keyword">class </span><a class="code" href="classBLEProcess.html">BLEProcess</a> : <span class="keyword">private</span> mbed::NonCopyable&lt;BLEProcess&gt;, <span class="keyword">public</span> ble::Gap::EventHandler</div>
<div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;{</div>
<div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;<span class="keyword">public</span>:</div>
<div class="line"><a name="l00044"></a><span class="lineno"><a class="line" href="classBLEProcess.html#a873642e0a367dadd5824eb7ba68a68c4">   44</a></span>&#160;    <a class="code" href="classBLEProcess.html#a873642e0a367dadd5824eb7ba68a68c4">BLEProcess</a>(events::EventQueue &amp;event_queue, BLE &amp;ble_interface) : _event_queue(event_queue),</div>
<div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;                                                                      _ble(ble_interface),</div>
<div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;                                                                      _gap(ble_interface.gap()),</div>
<div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;                                                                      _adv_data_builder(_adv_buffer)</div>
<div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;    {</div>
<div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;    }</div>
<div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160; </div>
<div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;    ~<a class="code" href="classBLEProcess.html">BLEProcess</a>()</div>
<div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;    {</div>
<div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;        <a class="code" href="classBLEProcess.html#a36d39e419f3629cfa4d27e604e2e09a0">stop</a>();</div>
<div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;    }</div>
<div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160; </div>
<div class="line"><a name="l00063"></a><span class="lineno"><a class="line" href="classBLEProcess.html#ab764787f8da27e19690c012ef8f20d2d">   63</a></span>&#160;    <span class="keywordtype">void</span> <a class="code" href="classBLEProcess.html#ab764787f8da27e19690c012ef8f20d2d">start</a>()</div>
<div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;    {</div>
<div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;        <a class="code" href="syslogger_8h.html#ad92f88d4f27ff0399a98959459f2e102">LOGI</a>(<span class="stringliteral">&quot;Ble process started.\r\n&quot;</span>);</div>
<div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160; </div>
<div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;        <span class="keywordflow">if</span> (_ble.hasInitialized())</div>
<div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;        {</div>
<div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;            <a class="code" href="syslogger_8h.html#ab1cdcb0d9a10be14a1ab0f1d385b02cb">LOGE</a>(<span class="stringliteral">&quot;Error: the ble instance has already been initialized.\r\n&quot;</span>);</div>
<div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;            <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;        }</div>
<div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160; </div>
<div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;        _gap.setEventHandler(<span class="keyword">this</span>);</div>
<div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160; </div>
<div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;        _ble.onEventsToProcess(</div>
<div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;            makeFunctionPointer(<span class="keyword">this</span>, &amp;<a class="code" href="classBLEProcess.html#ad6cc6646fcb055c09d810e48670dd557">BLEProcess::schedule_ble_events</a>));</div>
<div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160; </div>
<div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;        ble_error_t error = _ble.init(</div>
<div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;            <span class="keyword">this</span>, &amp;<a class="code" href="classBLEProcess.html#a2bba574bccf73463b2471130d0cedb50">BLEProcess::onInitComplete</a>);</div>
<div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160; </div>
<div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;        <span class="keywordflow">if</span> (error)</div>
<div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;        {</div>
<div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;            <a class="code" href="syslogger_8h.html#ab1cdcb0d9a10be14a1ab0f1d385b02cb">LOGE</a>(<span class="stringliteral">&quot;Error returned by BLE::init.\r\n&quot;</span>);</div>
<div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;            <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;        }</div>
<div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;        _event_queue.dispatch_forever();</div>
<div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;        <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;    }</div>
<div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160; </div>
<div class="line"><a name="l00095"></a><span class="lineno"><a class="line" href="classBLEProcess.html#a36d39e419f3629cfa4d27e604e2e09a0">   95</a></span>&#160;    <span class="keywordtype">void</span> <a class="code" href="classBLEProcess.html#a36d39e419f3629cfa4d27e604e2e09a0">stop</a>()</div>
<div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;    {</div>
<div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;        <span class="keywordflow">if</span> (_ble.hasInitialized())</div>
<div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;        {</div>
<div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;            _ble.shutdown();</div>
<div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;            <a class="code" href="syslogger_8h.html#ab1cdcb0d9a10be14a1ab0f1d385b02cb">LOGE</a>(<span class="stringliteral">&quot;BLE process stopped.&quot;</span>);</div>
<div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;        }</div>
<div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;    }</div>
<div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160; </div>
<div class="line"><a name="l00111"></a><span class="lineno"><a class="line" href="classBLEProcess.html#a9ffa671357486def5f6327937570360a">  111</a></span>&#160;    <span class="keywordtype">void</span> <a class="code" href="classBLEProcess.html#a9ffa671357486def5f6327937570360a">onInit</a>(mbed::Callback&lt;<span class="keywordtype">void</span>(BLE &amp;, events::EventQueue &amp;)&gt; cb)</div>
<div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;    {</div>
<div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;        _post_init_cb = cb;</div>
<div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;    }</div>
<div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160; </div>
<div class="line"><a name="l00123"></a><span class="lineno"><a class="line" href="classBLEProcess.html#abced5eac43b8200e890715d91770c078">  123</a></span>&#160;    <span class="keywordtype">void</span> <a class="code" href="classBLEProcess.html#abced5eac43b8200e890715d91770c078">on_connect</a>(mbed::Callback&lt;<span class="keywordtype">void</span>(BLE &amp;, events::EventQueue &amp;, <span class="keyword">const</span> ble::ConnectionCompleteEvent &amp;event)&gt; cb)</div>
<div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;    {</div>
<div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;        _post_connect_cb = cb;</div>
<div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;    }</div>
<div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160; </div>
<div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;    <span class="keyword">virtual</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *get_device_name()</div>
<div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;    {</div>
<div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;        <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> name[] = <span class="stringliteral">&quot;BLE-Process&quot;</span>;</div>
<div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;        <span class="keywordflow">return</span> name;</div>
<div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;    }</div>
<div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160; </div>
<div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;<span class="keyword">protected</span>:</div>
<div class="line"><a name="l00144"></a><span class="lineno"><a class="line" href="classBLEProcess.html#a2bba574bccf73463b2471130d0cedb50">  144</a></span>&#160;    <span class="keywordtype">void</span> <a class="code" href="classBLEProcess.html#a2bba574bccf73463b2471130d0cedb50">onInitComplete</a>(BLE::InitializationCompleteCallbackContext *event)</div>
<div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;    {</div>
<div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;        <span class="keywordflow">if</span> (event-&gt;error)</div>
<div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;        {</div>
<div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;            <a class="code" href="syslogger_8h.html#ab1cdcb0d9a10be14a1ab0f1d385b02cb">LOGE</a>(<span class="stringliteral">&quot;Error during the initialisation\r\n&quot;</span>);</div>
<div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;            <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;        }</div>
<div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160; </div>
<div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;        <a class="code" href="syslogger_8h.html#ad92f88d4f27ff0399a98959459f2e102">LOGI</a>(<span class="stringliteral">&quot;Ble instance initialized\r\n&quot;</span>);</div>
<div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160; </div>
<div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;        <a class="code" href="classBLEProcess.html#a576d2ffba6cedf406f2512e57f5cd1df">start_activity</a>();</div>
<div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160; </div>
<div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;        <span class="keywordflow">if</span> (_post_init_cb)</div>
<div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;        {</div>
<div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;            _post_init_cb(_ble, _event_queue);</div>
<div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;        }</div>
<div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;    }</div>
<div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160; </div>
<div class="line"><a name="l00171"></a><span class="lineno"><a class="line" href="classBLEProcess.html#afb46261be6eecd0bced54de467bad2a5">  171</a></span>&#160;    <span class="keywordtype">void</span> <a class="code" href="classBLEProcess.html#afb46261be6eecd0bced54de467bad2a5">onConnectionComplete</a>(<span class="keyword">const</span> ble::ConnectionCompleteEvent &amp;event)<span class="keyword"> override</span></div>
<div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;<span class="keyword">    </span>{</div>
<div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;        <span class="keywordflow">if</span> (event.getStatus() == BLE_ERROR_NONE)</div>
<div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;        {</div>
<div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;            <a class="code" href="syslogger_8h.html#ad92f88d4f27ff0399a98959459f2e102">LOGI</a>(<span class="stringliteral">&quot;Connected to BLE device&quot;</span>);</div>
<div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;            <span class="comment">// event.getPeerAddress();</span></div>
<div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160; </div>
<div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;            <span class="keywordflow">if</span> (_post_connect_cb)</div>
<div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;            {</div>
<div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;                _post_connect_cb(_ble, _event_queue, event);</div>
<div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;            }</div>
<div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;        }</div>
<div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;        {</div>
<div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;            <a class="code" href="syslogger_8h.html#ab1cdcb0d9a10be14a1ab0f1d385b02cb">LOGE</a>(<span class="stringliteral">&quot;Failed to connect\r\n&quot;</span>);</div>
<div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;            <a class="code" href="classBLEProcess.html#a576d2ffba6cedf406f2512e57f5cd1df">start_activity</a>();</div>
<div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;        }</div>
<div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;    }</div>
<div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160; </div>
<div class="line"><a name="l00199"></a><span class="lineno"><a class="line" href="classBLEProcess.html#ab6f56368e24ee0f7e9632504a69043c3">  199</a></span>&#160;    <span class="keywordtype">void</span> <a class="code" href="classBLEProcess.html#ab6f56368e24ee0f7e9632504a69043c3">onDisconnectionComplete</a>(<span class="keyword">const</span> ble::DisconnectionCompleteEvent &amp;event)<span class="keyword"> override</span></div>
<div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;<span class="keyword">    </span>{</div>
<div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;        <a class="code" href="syslogger_8h.html#ab1cdcb0d9a10be14a1ab0f1d385b02cb">LOGE</a>(<span class="stringliteral">&quot;Disconnected.\r\n&quot;</span>);</div>
<div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;        <a class="code" href="classBLEProcess.html#a576d2ffba6cedf406f2512e57f5cd1df">start_activity</a>();</div>
<div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;    }</div>
<div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160; </div>
<div class="line"><a name="l00212"></a><span class="lineno"><a class="line" href="classBLEProcess.html#adbf2d8c4bd3e5ff4b042cee7b6668435">  212</a></span>&#160;    <span class="keywordtype">void</span> <a class="code" href="classBLEProcess.html#adbf2d8c4bd3e5ff4b042cee7b6668435">onAdvertisingEnd</a>(<span class="keyword">const</span> ble::AdvertisingEndEvent &amp;event)</div>
<div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;    {</div>
<div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;        <a class="code" href="classBLEProcess.html#a576d2ffba6cedf406f2512e57f5cd1df">start_activity</a>();</div>
<div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;    }</div>
<div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160; </div>
<div class="line"><a name="l00224"></a><span class="lineno"><a class="line" href="classBLEProcess.html#a576d2ffba6cedf406f2512e57f5cd1df">  224</a></span>&#160;    <span class="keyword">virtual</span> <span class="keywordtype">void</span> <a class="code" href="classBLEProcess.html#a576d2ffba6cedf406f2512e57f5cd1df">start_activity</a>()</div>
<div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;    {</div>
<div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;        _event_queue.call([<span class="keyword">this</span>]()</div>
<div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;                          { <a class="code" href="classBLEProcess.html#a1e3134b41b1391b1bf6bf17007229b66">start_advertising</a>(); });</div>
<div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;    }</div>
<div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160; </div>
<div class="line"><a name="l00235"></a><span class="lineno"><a class="line" href="classBLEProcess.html#a1e3134b41b1391b1bf6bf17007229b66">  235</a></span>&#160;    <span class="keywordtype">void</span> <a class="code" href="classBLEProcess.html#a1e3134b41b1391b1bf6bf17007229b66">start_advertising</a>()</div>
<div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;    {</div>
<div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;        ble_error_t error;</div>
<div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160; </div>
<div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;        <span class="keywordflow">if</span> (_gap.isAdvertisingActive(_adv_handle))</div>
<div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;            <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160; </div>
<div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;        ble::AdvertisingParameters adv_params(</div>
<div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;            ble::advertising_type_t::CONNECTABLE_UNDIRECTED,</div>
<div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;            ble::adv_interval_t(ble::millisecond_t(40)));</div>
<div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160; </div>
<div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;        error = _gap.setAdvertisingParameters(_adv_handle, adv_params);</div>
<div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160; </div>
<div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;        <span class="keywordflow">if</span> (error)</div>
<div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;        {</div>
<div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;            <a class="code" href="syslogger_8h.html#ab1cdcb0d9a10be14a1ab0f1d385b02cb">LOGE</a>(<span class="stringliteral">&quot;_ble.gap().setAdvertisingParameters() failed\r\n&quot;</span>);</div>
<div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;            <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;        }</div>
<div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160; </div>
<div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;        _adv_data_builder.clear();</div>
<div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;        _adv_data_builder.setFlags();</div>
<div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;        _adv_data_builder.setName(get_device_name());</div>
<div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160; </div>
<div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;        <span class="comment">/* Set payload for the set */</span></div>
<div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;        error = _gap.setAdvertisingPayload(</div>
<div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;            _adv_handle, _adv_data_builder.getAdvertisingData());</div>
<div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160; </div>
<div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;        <span class="keywordflow">if</span> (error)</div>
<div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;        {</div>
<div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;            <a class="code" href="syslogger_8h.html#ab1cdcb0d9a10be14a1ab0f1d385b02cb">LOGE</a>(<span class="stringliteral">&quot;Gap::setAdvertisingPayload() failed\r\n&quot;</span>);</div>
<div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;            <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;        }</div>
<div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160; </div>
<div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;        error = _gap.startAdvertising(_adv_handle, ble::adv_duration_t(ble::millisecond_t(4000)));</div>
<div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160; </div>
<div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;        <span class="keywordflow">if</span> (error)</div>
<div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;        {</div>
<div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;            <a class="code" href="syslogger_8h.html#ab1cdcb0d9a10be14a1ab0f1d385b02cb">LOGE</a>(<span class="stringliteral">&quot;Gap::startAdvertising() failed\r\n&quot;</span>);</div>
<div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;            <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;        }</div>
<div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160; </div>
<div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;        <a class="code" href="syslogger_8h.html#ad92f88d4f27ff0399a98959459f2e102">LOGI</a>(<span class="stringliteral">&quot;Advertising as Nordic device.\r\n&quot;</span>);</div>
<div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;    }</div>
<div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160; </div>
<div class="line"><a name="l00286"></a><span class="lineno"><a class="line" href="classBLEProcess.html#ad6cc6646fcb055c09d810e48670dd557">  286</a></span>&#160;    <span class="keywordtype">void</span> <a class="code" href="classBLEProcess.html#ad6cc6646fcb055c09d810e48670dd557">schedule_ble_events</a>(BLE::OnEventsToProcessCallbackContext *event)</div>
<div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;    {</div>
<div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;        _event_queue.call(mbed::callback(&amp;event-&gt;ble, &amp;BLE::processEvents));</div>
<div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;    }</div>
<div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160; </div>
<div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;<span class="keyword">protected</span>:</div>
<div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;    events::EventQueue &amp;_event_queue;</div>
<div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;    BLE &amp;_ble;</div>
<div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;    ble::Gap &amp;_gap;</div>
<div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160; </div>
<div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;    uint8_t _adv_buffer[MAX_ADVERTISING_PAYLOAD_SIZE];</div>
<div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;    ble::AdvertisingDataBuilder _adv_data_builder;</div>
<div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160; </div>
<div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;    ble::advertising_handle_t _adv_handle = ble::LEGACY_ADVERTISING_HANDLE;</div>
<div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160; </div>
<div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;    mbed::Callback&lt;void(BLE &amp;, events::EventQueue &amp;)&gt; _post_init_cb;</div>
<div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;    mbed::Callback&lt;void(BLE &amp;, events::EventQueue &amp;, <span class="keyword">const</span> ble::ConnectionCompleteEvent &amp;event)&gt; _post_connect_cb;</div>
<div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;};</div>
<div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160; </div>
<div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;<span class="keyword">using</span> mbed::callback;</div>
<div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;<span class="keyword">using namespace </span>std::literals::chrono_literals;</div>
<div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160; </div>
<div class="line"><a name="l00313"></a><span class="lineno"><a class="line" href="classGattServerProcess.html">  313</a></span>&#160;<span class="keyword">class </span><a class="code" href="classGattServerProcess.html">GattServerProcess</a> : <span class="keyword">public</span> <a class="code" href="classBLEProcess.html">BLEProcess</a></div>
<div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;{</div>
<div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;<span class="keyword">public</span>:</div>
<div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;    <a class="code" href="classGattServerProcess.html">GattServerProcess</a>(events::EventQueue &amp;event_queue, BLE &amp;ble_interface) : <a class="code" href="classBLEProcess.html">BLEProcess</a>(event_queue, ble_interface)</div>
<div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;    {</div>
<div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;    }</div>
<div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160; </div>
<div class="line"><a name="l00325"></a><span class="lineno"><a class="line" href="classGattServerProcess.html#a25aab23336b1daf8afd2d11f6de56aa8">  325</a></span>&#160;    <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="classGattServerProcess.html#a25aab23336b1daf8afd2d11f6de56aa8">get_device_name</a>()<span class="keyword"> override</span></div>
<div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;<span class="keyword">    </span>{</div>
<div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;        <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> name[] = DEV_NAME;</div>
<div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;        <span class="keywordflow">return</span> name;</div>
<div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;    }</div>
<div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;};</div>
<div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160; </div>
<div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="ttc" id="aclassBLEProcess_html"><div class="ttname"><a href="classBLEProcess.html">BLEProcess</a></div><div class="ttdoc">Inherit general handler of GAP-related events.</div><div class="ttdef"><b>Definition:</b> gattserver.h:39</div></div>
<div class="ttc" id="aclassBLEProcess_html_a1e3134b41b1391b1bf6bf17007229b66"><div class="ttname"><a href="classBLEProcess.html#a1e3134b41b1391b1bf6bf17007229b66">BLEProcess::start_advertising</a></div><div class="ttdeci">void start_advertising()</div><div class="ttdoc">Start the advertising process, ends when a device connects.</div><div class="ttdef"><b>Definition:</b> gattserver.h:235</div></div>
<div class="ttc" id="aclassBLEProcess_html_a2bba574bccf73463b2471130d0cedb50"><div class="ttname"><a href="classBLEProcess.html#a2bba574bccf73463b2471130d0cedb50">BLEProcess::onInitComplete</a></div><div class="ttdeci">void onInitComplete(BLE::InitializationCompleteCallbackContext *event)</div><div class="ttdoc">Sets up adverting payload and start advertising.</div><div class="ttdef"><b>Definition:</b> gattserver.h:144</div></div>
<div class="ttc" id="aclassBLEProcess_html_a36d39e419f3629cfa4d27e604e2e09a0"><div class="ttname"><a href="classBLEProcess.html#a36d39e419f3629cfa4d27e604e2e09a0">BLEProcess::stop</a></div><div class="ttdeci">void stop()</div><div class="ttdoc">Close existing connections and stop the process.</div><div class="ttdef"><b>Definition:</b> gattserver.h:95</div></div>
<div class="ttc" id="aclassBLEProcess_html_a576d2ffba6cedf406f2512e57f5cd1df"><div class="ttname"><a href="classBLEProcess.html#a576d2ffba6cedf406f2512e57f5cd1df">BLEProcess::start_activity</a></div><div class="ttdeci">virtual void start_activity()</div><div class="ttdoc">Start advertising/scanning.</div><div class="ttdef"><b>Definition:</b> gattserver.h:224</div></div>
<div class="ttc" id="aclassBLEProcess_html_a873642e0a367dadd5824eb7ba68a68c4"><div class="ttname"><a href="classBLEProcess.html#a873642e0a367dadd5824eb7ba68a68c4">BLEProcess::BLEProcess</a></div><div class="ttdeci">BLEProcess(events::EventQueue &amp;event_queue, BLE &amp;ble_interface)</div><div class="ttdoc">Construct a BLEProcess from an event queue and a ble interface.</div><div class="ttdef"><b>Definition:</b> gattserver.h:44</div></div>
<div class="ttc" id="aclassBLEProcess_html_a9ffa671357486def5f6327937570360a"><div class="ttname"><a href="classBLEProcess.html#a9ffa671357486def5f6327937570360a">BLEProcess::onInit</a></div><div class="ttdeci">void onInit(mbed::Callback&lt; void(BLE &amp;, events::EventQueue &amp;)&gt; cb)</div><div class="ttdoc">Subscription to the BLE interface initialization event.</div><div class="ttdef"><b>Definition:</b> gattserver.h:111</div></div>
<div class="ttc" id="aclassBLEProcess_html_ab6f56368e24ee0f7e9632504a69043c3"><div class="ttname"><a href="classBLEProcess.html#ab6f56368e24ee0f7e9632504a69043c3">BLEProcess::onDisconnectionComplete</a></div><div class="ttdeci">void onDisconnectionComplete(const ble::DisconnectionCompleteEvent &amp;event) override</div><div class="ttdoc">Stop the gatt client process when the device is disconnected.</div><div class="ttdef"><b>Definition:</b> gattserver.h:199</div></div>
<div class="ttc" id="aclassBLEProcess_html_ab764787f8da27e19690c012ef8f20d2d"><div class="ttname"><a href="classBLEProcess.html#ab764787f8da27e19690c012ef8f20d2d">BLEProcess::start</a></div><div class="ttdeci">void start()</div><div class="ttdoc">Initialize the ble interface, configure it and start advertising.</div><div class="ttdef"><b>Definition:</b> gattserver.h:63</div></div>
<div class="ttc" id="aclassBLEProcess_html_abced5eac43b8200e890715d91770c078"><div class="ttname"><a href="classBLEProcess.html#abced5eac43b8200e890715d91770c078">BLEProcess::on_connect</a></div><div class="ttdeci">void on_connect(mbed::Callback&lt; void(BLE &amp;, events::EventQueue &amp;, const ble::ConnectionCompleteEvent &amp;event)&gt; cb)</div><div class="ttdoc">Set callback for a succesful connection.</div><div class="ttdef"><b>Definition:</b> gattserver.h:123</div></div>
<div class="ttc" id="aclassBLEProcess_html_ad6cc6646fcb055c09d810e48670dd557"><div class="ttname"><a href="classBLEProcess.html#ad6cc6646fcb055c09d810e48670dd557">BLEProcess::schedule_ble_events</a></div><div class="ttdeci">void schedule_ble_events(BLE::OnEventsToProcessCallbackContext *event)</div><div class="ttdoc">Schedule processing of events from the BLE middleware in the event queue.</div><div class="ttdef"><b>Definition:</b> gattserver.h:286</div></div>
<div class="ttc" id="aclassBLEProcess_html_adbf2d8c4bd3e5ff4b042cee7b6668435"><div class="ttname"><a href="classBLEProcess.html#adbf2d8c4bd3e5ff4b042cee7b6668435">BLEProcess::onAdvertisingEnd</a></div><div class="ttdeci">void onAdvertisingEnd(const ble::AdvertisingEndEvent &amp;event)</div><div class="ttdoc">Restarts main activity.</div><div class="ttdef"><b>Definition:</b> gattserver.h:212</div></div>
<div class="ttc" id="aclassBLEProcess_html_afb46261be6eecd0bced54de467bad2a5"><div class="ttname"><a href="classBLEProcess.html#afb46261be6eecd0bced54de467bad2a5">BLEProcess::onConnectionComplete</a></div><div class="ttdeci">void onConnectionComplete(const ble::ConnectionCompleteEvent &amp;event) override</div><div class="ttdoc">Start the gatt client process when a connection event is received.</div><div class="ttdef"><b>Definition:</b> gattserver.h:171</div></div>
<div class="ttc" id="aclassGattServerProcess_html"><div class="ttname"><a href="classGattServerProcess.html">GattServerProcess</a></div><div class="ttdoc">Gatt Server Process for our service.</div><div class="ttdef"><b>Definition:</b> gattserver.h:314</div></div>
<div class="ttc" id="aclassGattServerProcess_html_a25aab23336b1daf8afd2d11f6de56aa8"><div class="ttname"><a href="classGattServerProcess.html#a25aab23336b1daf8afd2d11f6de56aa8">GattServerProcess::get_device_name</a></div><div class="ttdeci">const char * get_device_name() override</div><div class="ttdoc">Get device name for nRF Connect</div><div class="ttdef"><b>Definition:</b> gattserver.h:325</div></div>
<div class="ttc" id="asyslogger_8h_html"><div class="ttname"><a href="syslogger_8h.html">syslogger.h</a></div></div>
<div class="ttc" id="asyslogger_8h_html_ab1cdcb0d9a10be14a1ab0f1d385b02cb"><div class="ttname"><a href="syslogger_8h.html#ab1cdcb0d9a10be14a1ab0f1d385b02cb">LOGE</a></div><div class="ttdeci">void LOGE(const char *message)</div><div class="ttdoc">Simple log to the terminal appropriate message.</div><div class="ttdef"><b>Definition:</b> syslogger.h:238</div></div>
<div class="ttc" id="asyslogger_8h_html_ad92f88d4f27ff0399a98959459f2e102"><div class="ttname"><a href="syslogger_8h.html#ad92f88d4f27ff0399a98959459f2e102">LOGI</a></div><div class="ttdeci">void LOGI(const char *message)</div><div class="ttdoc">Simple log to the terminal appropriate message.</div><div class="ttdef"><b>Definition:</b> syslogger.h:204</div></div>
</div><!-- fragment --></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1
</small></address>
</body>
</html>
